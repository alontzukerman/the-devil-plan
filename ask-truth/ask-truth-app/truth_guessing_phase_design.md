# Truth Guessing Phase Design (`TruthGuessingScreen.tsx`)\n\n## 1. Objective\n\nThe player who won the bid and chose \"Truth\" (the \"Guesser\") attempts to correctly identify the opponent\'s (the \"Target\'s\") secret 8-card series. A correct guess wins the game. A wrong guess leads to the next round.\n\n## 2. Trigger\n\n1.  A player (Guesser) wins the bid in the Bidding Phase.\n2.  The Guesser chooses the \"TRUTH\" action.\n3.  The server receives the `playerMadeChoice` event with `{ choice: \'truth\' }`.\n4.  Server transitions the game state and initiates the Truth Guessing Phase.\n\n## 3. UI - Guesser (`TruthGuessingScreen.tsx`)\n\n*   **Navigation:** Guesser is navigated to `/game/:gameId/guess-truth`.\n*   **Screen Title:** \"Truth Phase: Guess [Target\'s Name]\'s Series\"\n*   **Information Display:**\n    *   Static text: \"You chose TRUTH.\"\n    *   Instruction: \"Attempt to reconstruct [Target\'s Name]\'s 8-card secret series.\"\n*   **Available Cards Display (Full Deck):\n    *   Displays all 52 standard playing cards, grouped by suit (e.g., Hearts, Diamonds, Clubs, Spades).\n    *   Each card is a `CardComponent`.\n    *   Clicking a card adds it to the `guessedSeries` if the series length is less than 8 and the card is not already in `guessedSeries`.\n    *   Cards in `guessedSeries` should appear disabled or visually distinct in the main deck display.\n*   **Guessed Series Display Area:**\n    *   Horizontally displays the 8 cards selected by the Guesser *in the order they were selected*.\n    *   Each card in this area is also a `CardComponent`.\n    *   Clicking a card in this area removes it from `guessedSeries` (deselects it).\n    *   Shows current selection count: \"Selected: [X] / 8 cards\".\n*   **Action Buttons:**\n    *   **\"Confirm Guess\" Button:**\n        *   Text: \"Confirm Guess\"\n        *   Enabled only when `guessedSeries.length === 8`.\n        *   Disabled if `isGuessConfirmed` is true.\n    *   **\"Reset Guess\" Button:**\n        *   Text: \"Reset Guess\"\n        *   Clears the `guessedSeries` array.\n        *   Enabled if `guessedSeries.length > 0`.\n        *   Disabled if `isGuessConfirmed` is true.\n*   **Status Message Area:**\n    *   Initial: \"Select 8 cards in the order you believe [Target\'s Name] arranged them.\"\n    *   After confirming guess: \"Your guess has been submitted. Waiting for the result...\"\n\n## 4. UI - Target (Remains on `BiddingScreen.tsx` or current screen)\n\n*   Their `BiddingScreen` UI (or current game screen) should display a status message like:\n    *   \"[Guesser\'s Name] won the bid and chose TRUTH.\"\n    *   \"[Guesser\'s Name] is now attempting to guess your secret series... Please wait.\"\n*   No direct actions are available for the Target during this phase.\n\n## 5. State Variables (Client - Guesser on `TruthGuessingScreen.tsx`)\n\n*   `gameId`: string (from `useParams`).\n*   `targetName`: string (passed via route state or from a game state update).\n*   `deck`: `CardType[]` (standard 52 cards, generated by `generateDeck()`).\n*   `guessedSeries`: `CardType[]` (the 8 cards selected by the Guesser, in order of selection).\n*   `statusMessage`: string (for providing instructions and feedback).\n*   `isGuessConfirmed`: boolean (set to true after submitting the guess to disable further actions).\n\n## 6. Socket Events\n\n### Listeners (for both Guesser & Target, handled on their respective screens):\n\n1.  **`startTruthGuessingPhase`** (Emitted by Server)\n    *   **Payload (to Guesser):** `{ gameId: string, targetPlayerName: string, // other relevant state }`\n        *   Client uses this to know who the target is.\n    *   **Payload (to Target):** `{ gameId: string, guesserPlayerName: string, // other relevant state }`\n        *   Client uses this to display who is guessing.\n    *   **Action (Guesser):** The `allReadyNavigateToBidding` event (renamed or a new one like `navigateToTruthGuess`) would have already navigated the guesser. This event confirms the phase and provides opponent name.\n    *   **Action (Target):** Update UI on `BiddingScreen` (or current screen) to show \"[Guesser\'s Name] is guessing your series...\"\n\n2.  **`truthGuessResult`** (Emitted by Server to both players)\n    *   **Payload:** `{ gameId: string, wasGuessCorrect: boolean, winnerId?: string, winnerName?: string }`\n        *   `winnerId` and `winnerName` are present if `wasGuessCorrect` is true.\n    *   **Action (Guesser - on `TruthGuessingScreen`):**\n        *   If `wasGuessCorrect` is true: Set `statusMessage` to \"Correct! You win the game!\" and navigate to `GameOverScreen` with winner info.\n        *   If `wasGuessCorrect` is false: Set `statusMessage` to \"Incorrect guess. The game continues...\" After a short delay, server will likely send `biddingPhaseState` or client will be navigated back to bidding screen.\n    *   **Action (Target - on `BiddingScreen` or current screen):**\n        *   If `wasGuessCorrect` is true: Set message to \"[Guesser\'s Name]\'s guess was CORRECT! [Guesser\'s Name] wins!\" and navigate to `GameOverScreen`.\n        *   If `wasGuessCorrect` is false: Set message to \"[Guesser\'s Name]\'s guess was INCORRECT. The game continues...\" (Server will then initiate next bidding round).\n\n### Emitters (from Guesser on `TruthGuessingScreen.tsx` to Server):\n\n1.  **`submitTruthGuess`**\n    *   **Payload:** `{ gameId: string, guessedSeries: ServerCard[] }`\n        *   `guessedSeries` is an array of 8 `ServerCard` objects (just `suit` and `rank`, `id` can be omitted or ignored by server for comparison if it only cares about suit/rank).\n    *   **Action:** Sent when the Guesser clicks \"Confirm Guess\". Client sets `isGuessConfirmed = true`.\n\n## 7. Server-Side Logic (`server.ts`)\n\n1.  **`Game` Interface Extension (Consideration):**\n    *   Add `currentPhase: \'bidding\' | \'cardSelection\' | \'truthGuessing\' | \'askQuestion\' | \'gameOver\'` to track the game state more explicitly. Initialize to `cardSelection` or `bidding`.\n    *   Store `bidWinnerId` on the game object after a bid is resolved to know who has the right to choose Ask/Truth.\n\n2.  **Handle `playerMadeChoice` (when `choice === \'truth\'`):**\n    *   Verify that `socket.id` is the current `game.bidWinnerId`.\n    *   Set `game.currentPhase = \'truthGuessing\'` (if using this state).\n    *   Identify Guesser (`socket.id`) and Target (the other player).\n    *   Emit `startTruthGuessingPhase` to Guesser (e.g., `{ targetPlayerName: Target.name }`). This might be part of a navigation event like `navigateToTruthGuess` for the guesser: `io.to(guesser.id).emit(\'navigateToTruthGuess\', { gameId, path: \`/game/${gameId}/guess-truth\`, targetPlayerName: target.name });`\n    *   Emit `startTruthGuessingPhase` (or a more specific `opponentIsGuessing`) to Target (e.g., `{ guesserPlayerName: Guesser.name }`).\n\n3.  **Handle `submitTruthGuess` Event:**\n    *   Receive `gameId` and `guessedSeries` from Guesser.\n    *   Validate: Guesser is part of the game, it\'s currently `truthGuessing` phase, and this player is the one who should be guessing.\n    *   Retrieve Target player\'s actual `selectedSeries` (e.g., `game.selectedSeries[targetId]`).\n    *   **Comparison Logic:**\n        *   Ensure `guessedSeries` has 8 cards.\n        *   Iterate through both `guessedSeries` and `targetSeries` simultaneously.\n        *   For each card, compare `suit` and `rank`. If any card doesn\'t match in order, the guess is incorrect.\n        *   If all 8 cards match in suit, rank, and order, the guess is correct.\n    *   If guess is correct:\n        *   Set `game.currentPhase = \'gameOver\'`.\n        *   Emit `truthGuessResult` to both players in the room (`io.to(gameId).emit(...)`) with `{ wasGuessCorrect: true, winnerId: guesser.id, winnerName: guesser.name }`.\n        *   (Optional: Game cleanup logic after a delay, or when a new game is created by these players).\n    *   If guess is incorrect:\n        *   Emit `truthGuessResult` to both players with `{ wasGuessCorrect: false }`.\n        *   Set `game.currentPhase = \'bidding\'` (if using phase state).\n        *   After a short delay (e.g., 3-5 seconds for players to read the result), call `startBiddingPhase(gameId)` to initiate the next bidding round.\n\n## 8. Navigation Flow Example\n\n1.  Bid winner (Player A) on `BiddingScreen` clicks \"Choose TRUTH\".\n2.  Server receives `playerMadeChoice`.\n3.  Server emits `navigateToTruthGuess` to Player A (path: `/game/:gameId/guess-truth`, payload includes `targetPlayerName`).\n4.  Server emits `opponentIsGuessing` to Player B (payload includes `guesserPlayerName`).\n5.  Player A navigates to `TruthGuessingScreen` and sees UI to select cards.\n6.  Player B sees \"Player A is guessing...\" on their `BiddingScreen`.\n7.  Player A submits guess. Server processes.\n8.  Server emits `truthGuessResult`.\n    *   **Win:** Both players see win/loss messages. Both navigate to `GameOverScreen` (e.g., via a `navigateToGameOver` event from server or client-side logic after receiving win result).\n    *   **Loss:** Both players see \"Incorrect guess\". After a delay, server sends `biddingPhaseState`, effectively restarting the bidding round (clients remain on/are directed back to `BiddingScreen`).\n\n## 9. Game Over Screen (`GameOverScreen.tsx`)\n\n*   A new simple component that displays:\n    *   \"Game Over!\"\n    *   \"Winner: [Winner\'s Name]\"\n    *   (Optional) Buttons for \"Play Again?\" or \"Back to Start Screen\". 